# batch_qq.py 処理フロー

## 全体フロー

```
開始
  ↓
codelist.csv読み込み
  ↓
証券コードリストの検証
  ↓
各銘柄の順次処理
  ↓
結果のCSV出力
  ↓
終了
```

## 詳細処理フロー

### 1. 初期化処理
1. codelist.csv の存在確認（UTF-8-sig形式）
2. 証券コード・銘柄名の読み込み（ヘッダー付きCSV）
3. 空値・不正値の除外
4. 処理対象銘柄数の表示

### 2. 銘柄別処理ループ
各銘柄に対して以下を実行：

#### 2.1 データ取得
1. 株探ページからHTMLを取得
2. 決算月の動的検出
3. 四半期データの抽出
4. PDFから財政状態データの取得

#### 2.2 計算処理
1. 成長率計算（売上高・四半期）
2. 経常益利回り計算
3. 四半期割安率計算（3種類）
4. 週足株価データ取得（複数ページ、両テーブル）
5. 発表日と株価のマッチング（+1日ロジック）
6. 相関計算（四半期成長率と株価、経常益利回りと株価）

#### 2.3 データ選択・変換
1. 決算期による新しい順ソート
2. 最新データ（先頭）の選択
3. 必要な項目のみ抽出
4. パーセント項目の100分の1変換（小数形式へ）
5. 銘柄名の追加
6. 株価データの適切な列位置への配置（銘柄名と発表日の間）
7. 相関データの追加（最新四半期のみ）

#### 2.4 エラーハンドリング
- ページ取得失敗 → None返却
- データ不足 → None返却  
- 処理例外 → エラーログ出力

### 3. 結果集計・出力
1. 成功した銘柄データの収集
2. DataFrameへの変換
3. 数値列の型変換
4. CSV出力（UTF-8-sig）
5. 処理結果サマリー表示

## データフロー

```
codelist.csv (UTF-8-sig, ヘッダー付き)
  ↓ (読み込み)
証券コード・銘柄名リスト
  ↓ (各銘柄処理)
株探HTML + PDF + 週足株価データ
  ↓ (データ抽出・計算・相関分析)
四半期財務データ + 株価データ + 相関データ（%形式）
  ↓ (最新データ選択・変換・列順序最適化)
銘柄別最新データ + 株価データ + 相関データ（小数形式）
  ↓ (集計)
batch_summary.csv (UTF-8-sig)
```

## 処理時間の考慮
- 銘柄間で3秒待機
- PDFダウンロード時の1秒待機
- 週足データ取得時の適切なリクエスト間隔
- サーバー負荷軽減を重視した設計

## 新機能: 株価データ統合と相関分析
- 複数ページの週足データ取得（page=1, page=2）
- 2つのHTMLテーブル対応（stock_kabuka_dwm + stock_kabuka0）
- 発表日+1日ロジックでの株価マッチング
- YY/MM/DD形式からYYYY/MM/DD形式への自動変換
- 最新3四半期データでの相関係数計算（numpy.corrcoef）
- 相関データは最新四半期のみ出力（他は空白）

## 出力ファイル
- `data/output/batch_summary.csv`
- 処理成功した銘柄のみ出力
- エンコーディング: UTF-8-sig（Excel互換）