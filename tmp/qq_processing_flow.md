# QoQ データ処理フロー

株探四半期成長率計算ツールのデータ処理フローを説明します。

## 概要

このツールは株探（Kabutan）から四半期決算データとPDF財務諸表を取得し、成長率計算に必要なデータを自動で収集・整理します。

## 処理フロー全体図

```
1. 株探ページアクセス
   ↓
2. HTMLパース・テーブル抽出
   ↓
3. 決算月自動検出
   ↓
4. 四半期データ識別・抽出
   ↓
5. 四半期判定・データ付与
   ↓
6. PDFリンク生成・ダウンロード
   ↓
7. PDF解析・財政状態データ抽出
   ↓
8. 四半期成長率・経常益利回り・割安率計算
   ↓
9. 株価データ取得・マッチング
   ↓
10. 相関計算（四半期成長率と株価、経常益利回りと株価）
   ↓
11. データ統合・CSV出力
```

## 詳細処理フロー

### 1. 株探ページアクセス

**目的**: 財務データの取得元ページにアクセス

```python
url = f"https://kabutan.jp/stock/finance?code={code}"
```

**処理内容**:
- 指定された証券コード（動的指定可能）の財務ページにアクセス
- User-Agentを設定してHTTPリクエストを送信
- HTMLコンテンツを取得

**出力**: HTML文字列

### 2. HTMLパース・テーブル抽出

**目的**: HTMLから四半期データテーブルを特定

**処理内容**:
- BeautifulSoupでHTMLをパース
- 全テーブルを検索（約24個のテーブルが存在）
- 「I」で始まる四半期データ行を含むテーブルを特定
- 8行以上の四半期データを持つ最適なテーブルを選択

**識別条件**:
```python
# 四半期データ行の識別（動的年度対応）
if re.search(r'\d{2}\.\d{2}-\d{2}', first_cell):
```

**出力**: 四半期データを含む最適なテーブル

### 3. 決算月自動検出

**目的**: 銘柄固有の決算月を自動判定

**処理内容**:
```python
def get_fiscal_year_end_month(html: str) -> int:
    # パターン1: YYYY.MM形式（通期テーブルの標準形式）
    pattern1 = re.compile(r'(\d{4})\.(\d{2})')
    matches1 = pattern1.findall(str(soup))
    if matches1:
        return int(matches1[-1][1])  # 最新年度の決算月
    
    # パターン2: 連 YYYY.MM形式
    pattern2 = re.compile(r'連.*?(\d{4})\.(\d{2})')
    matches2 = pattern2.findall(str(soup))
    if matches2:
        return int(matches2[0][1])
    
    # デフォルトは3月決算
    return 3
```

**検出例**:
- 3月決算 → 3を返す
- 8月決算 → 8を返す  
- 12月決算 → 12を返す

**出力**: 決算月（整数値）

### 4. 四半期データ識別・抽出

**目的**: テーブルから各四半期の財務データを抽出

**抽出データ**:
- **決算期**: 正規表現で期間部分を抽出（例: 25.04-06）
- **売上高**: 2列目の数値
- **営業益**: 3列目（通常「－」）
- **経常益**: 4列目の数値
- **最終益**: 5列目の数値
- **修正1株益**: 6列目の数値
- **発表日**: 8列目の日付

**データ例**:
```
決算期: 25.04-06
売上高: 1,820,341
経常益: 689,941
最終益: 421,819
発表日: 25/08/07
```

### 5. 四半期判定・データ付与

**目的**: 決算月を基準に各期間を1Q〜4Qに動的判定

**処理内容**:
```python
def determine_quarter(period: str, fiscal_year_end_month: int) -> str:
    # 期間終了月を取得（例: "24.07-09" → 9）
    end_month = int(period.split('-')[1])
    
    # 決算月を基準に各四半期の終了月を計算
    q4_end = fiscal_year_end_month
    q3_end = (fiscal_year_end_month - 3) if fiscal_year_end_month > 3 else (fiscal_year_end_month + 9)
    q2_end = (fiscal_year_end_month - 6) if fiscal_year_end_month > 6 else (fiscal_year_end_month + 6)
    q1_end = (fiscal_year_end_month - 9) if fiscal_year_end_month > 9 else (fiscal_year_end_month + 3)
```

**判定例**（3月決算の場合）:
- 03月終了 → 4Q（本決算）
- 12月終了 → 3Q
- 09月終了 → 2Q
- 06月終了 → 1Q

**判定例**（8月決算の場合）:
- 08月終了 → 4Q（本決算）
- 05月終了 → 3Q
- 02月終了 → 2Q
- 11月終了 → 1Q

**判定例**（6月決算の場合）:
- 06月終了 → 4Q（本決算）
- 03月終了 → 3Q
- 12月終了 → 2Q
- 09月終了 → 1Q

**出力**: 四半期識別子（1Q, 2Q, 3Q, 4Q）

### 6. PDFリンク生成・ダウンロード

**目的**: 各四半期の決算PDF資料を取得

**リンク変換処理**:
```python
# 株探のリンク形式
/disclosures/pdf/20250807/140120250805531214/

# 実際のPDFのURL形式に変換
https://tdnet-pdf.kabutan.jp/20250807/140120250805531214.pdf
```

**ダウンロード処理**:
- 適切なヘッダー設定（User-Agent、Referer等）
- セッション管理でクッキー保持
- Content-TypeでPDFファイルであることを確認
- サーバー負荷軽減のため1秒間隔でダウンロード

### 7. PDF解析・財政状態データ抽出

**目的**: PDFから資産合計と資本合計を自動抽出

**解析手順**:

#### 5.1 PDF読み込み
```python
with pdfplumber.open(pdf_content) as pdf:
    # 最初の3ページをチェック
    for page_num in range(min(3, len(pdf.pages))):
```

#### 5.2 財政状態セクション検出
- 「（２）連結財政状態」セクションを探索
- 「資産合計」「資本合計」キーワードを含む行を特定

#### 5.3 データ抽出ロジック
```python
# セクション内で最新四半期のデータ行を探す
if (('年' in line or '四半期' in line) and 
    re.search(r'[\d,]{8,}', line)):  # 8桁以上の数値を含む
    
    # 大きな数値を順番に抽出
    numbers = re.findall(r'[\d,]{8,}', line)
    
    # 妥当性チェック（資産合計 > 資本合計）
    if (asset_candidate > equity_candidate and
        asset_candidate > 10000 and  # 100億円以上（百万円単位）
        equity_candidate > 1000):    # 10億円以上（百万円単位）
```

#### 5.4 抽出パターン例
```
# ソフトバンク（9984）の例
財政状態データ行: 2026年３月期第１四半期 44,841,782 13,603,799 11,201,007 25.0
抽出された大きな数値: ['44,841,782', '13,603,799', '11,201,007']
→ 資産合計: 44,841,782, 資本合計: 13,603,799

# ファーストリテイリング（9983）の例
財政状態データ行: 2025年８月期第１四半期 3,795,103 2,196,913 2,139,312 56.4
抽出された大きな数値: ['3,795,103', '2,196,913', '2,139,312']
→ 資産合計: 3,795,103, 資本合計: 2,196,913
```

### 8. 四半期成長率・経常益利回り・割安率計算

**目的**: 財務指標の自動計算

#### 8.1 四半期成長率計算

**計算式**:
```
成長率 = (現四半期 - 1年前の同四半期) / sum(abs(現四半期), abs(1期前), abs(2期前), abs(3期前))
```

**処理内容**:
- 経常益と売上高の両方で成長率を計算
- 1年前（4期前）のデータと比較
- 分母には現四半期を含む直近4期の絶対値の合計を使用
- データ不足の場合は計算不可（None）

**計算例**:
```
現四半期経常益: 689,941
1年前経常益: 566,321
直近4期: [689,941, 632,145, 578,892, 612,334]
成長率 = (689,941 - 566,321) / sum(abs([689,941, 632,145, 578,892, 612,334]))
     = 123,620 / 2,513,312 = 4.92%
```

#### 8.2 経常益利回り計算

**計算式（四半期別）**:
- **1Q**: 経常益 × 4 ÷ 資本合計 × 100
- **2Q**: 累計経常益 × 2 ÷ 資本合計 × 100  
- **3Q**: 累計経常益 × 1.33 ÷ 資本合計 × 100
- **4Q**: 累計経常益 ÷ 資本合計 × 100

**処理内容**:
- 年度ごとに経常益を累積計算
- 四半期判定結果に基づいて適切な係数を適用
- 資本合計データがない場合は計算不可

**計算例**（2Q の場合）:
```
1Q経常益: 180,000, 2Q経常益: 195,000
累計経常益: 375,000
資本合計: 13,603,799
利回り = (375,000 × 2) ÷ 13,603,799 × 100 = 5.51%
```

#### 8.3 四半期割安率計算

**計算種類**:
1. **四半期割安率_四半期平均**: 四半期成長率と同じ計算式を経常益利回りに適用
2. **四半期割安率_前年同期ベース**: 現四半期 - 前年同期（4期前）
3. **四半期割安率_前四半期**: 現四半期 - 前四半期（1期前）

**計算式**:
```python
# 四半期割安率_四四半期平均
discount_rate = (current_yield - year_ago_yield) / sum(abs(recent_4_quarters_yield)) * 100

# 四半期割安率_前年同期ベース
discount_rate = current_yield - year_ago_yield

# 四半期割安率_前四半期
discount_rate = current_yield - previous_quarter_yield
```

### 9. 株価データ取得・マッチング

**目的**: 週足株価データを取得し、発表日とマッチング

**処理内容**:
```python
def fetch_weekly_stock_data(code: str = "9984") -> List[Dict]:
    # 複数ページから週足データを取得
    for page in [1, 2]:
        # 過去データテーブル (stock_kabuka_dwm)
        # 今週データテーブル (stock_kabuka0)
        
def find_stock_price_after_announcement(weekly_data, announcement_date):
    # 発表日+1日の株価を探す
    # 存在しない場合は次に新しい日付を使用
```

**技術ポイント**:
- 2つのHTMLテーブルからデータ取得（stock_kabuka_dwm + stock_kabuka0）
- YY/MM/DD形式の日付をYYYY/MM/DD形式に変換
- 発表日+1日ロジックで的確な株価マッチング
- 約60レコードの週足データを取得

### 10. 相関計算（四半期成長率と株価、経常益利回りと株価）

**目的**: 財務指標と株価の相関関係を分析

**処理内容**:
```python
def calculate_stock_correlations(data_with_growth: List[Dict]) -> Dict:
    # 最新3四半期のデータを使用
    growth_rates = []
    yield_rates = []
    stock_prices = []
    
    # numpy.corrcoefで相関係数を計算
    growth_correlation = np.corrcoef(growth_rates, stock_prices)[0, 1]
    yield_correlation = np.corrcoef(yield_rates, stock_prices)[0, 1]
```

**出力内容**:
- 四半期成長率株価相関: 最新四半期のみ表示
- 経常益利回り株価相関: 最新四半期のみ表示

### 11. データ統合・CSV出力

**目的**: 全データを統合してCSVファイルに出力

**データ統合処理**:
```python
# 各四半期データに財政状態データを追加
data['資産合計'] = balance_data.get('資産合計')
data['資本合計'] = balance_data.get('資本合計')
```

**新機能処理**:
```python
# 四半期成長率と経常益利回りを計算
data_with_growth = calculate_qoq_growth_rate(data, fiscal_year_end_month)

# 不要な列を削除（営業益、最終益、修正1株益）
columns_to_drop = ['営業益', '最終益', '修正1株益']
df = df.drop(columns=columns_to_drop, errors='ignore')

# 最適化された列順序（全指標含む）
column_order = ['決算期', '四半期', '売上高', '経常益', '発表日', 'PDF_URL', 
                '資産合計', '資本合計', '売上高成長率', '四半期成長率', '経常益利回り',
                '四半期割安率_四半期平均', '四半期割安率_前年同期ベース', '四半期割安率_前四半期']
```

**CSV出力形式**:
```csv
決算期,四半期,売上高,経常益,発表日,PDF_URL,資産合計,資本合計,売上高成長率,四半期成長率,経常益利回り,四半期割安率_四半期平均,四半期割安率_前年同期ベース,四半期割安率_前四半期,株価日付,始値,四半期成長率株価相関,経常益利回り株価相関
25.04-06,1Q,83456.0,5033.0,25/08/08,https://tdnet-pdf.kabutan.jp/20250808/140120250807535018.pdf,295185.0,104138.0,4.35,13.28,19.33,14.43,11.12,0.72,2025/08/12,2249.0,0.747,-0.287
```

## エラーハンドリング

### PDF処理エラー
- PDFダウンロード失敗時: データはNullで継続
- PDF解析失敗時: エラーメッセージ出力、他のデータは正常処理

### データ欠損対応
- 数値変換エラー: pandas.to_numeric()でNaN処理
- 必須データ不足: エラーメッセージ出力

### ネットワークエラー
- HTTPリクエスト失敗: リトライ機能なし（手動再実行）
- タイムアウト: 2分でタイムアウト設定

## パフォーマンス考慮

### 処理時間
- **HTML取得**: 約2-3秒
- **PDF処理**: 1ファイルあたり約15-20秒
- **全体**: 約2-3分（8つのPDF処理）

### サーバー負荷軽減
- PDFダウンロード間隔: 1秒
- 適切なUser-Agent設定
- セッション管理でクッキー保持

## 出力データの活用

取得されたCSVデータには以下の計算済み指標が含まれています：

### 財務指標
- **四半期成長率**: (現四半期 - 1年前の同四半期) / sum(abs(現四半期), abs(1期前), abs(2期前), abs(3期前))
- **売上高成長率**: 四半期成長率と同じ計算式を売上高に適用
- **経常益利回り**: 四半期別の年換算利回り（1Q=×4, 2Q=×2, 3Q=×1.33, 4Q=通期実績）
- **四半期割安率_四半期平均**: 成長率と同じ計算式を経常益利回りに適用
- **四半期割安率_前年同期ベース**: 経常益利回りの前年同期比較
- **四半期割安率_前四半期**: 経常益利回りの前四半期比較

### 基礎データ
- **売上高、経常益**: 成長率計算済み
- **資産合計、資本合計**: PDF自動抽出済み
- **決算期、四半期**: 時系列管理・四半期自動判定済み
- **発表日、PDF_URL**: トレーサビリティ確保

### 実装済み機能の特徴
- **動的決算月対応**: 3月、6月、8月決算など任意の決算月に自動対応
- **四半期自動判定**: 決算月を基準とした正確な1Q〜4Q判定
- **正確な成長率計算**: ユーザー指定の計算式を実装
- **経常益利回り**: 四半期ごとに異なる年換算係数で自動計算
- **3種類の割安率指標**: 四半期平均、前年同期ベース、前四半期ベース
- **動的年度検出**: 年度ハードコーディング排除、正規表現による柔軟な検出
- **PDFデータ抽出最適化**: 百万円単位対応、妥当性チェック改善
- **株価データ統合**: 週足データ取得、発表日+1日ロジック、YY/MM/DD形式対応
- **相関分析**: 四半期成長率と株価、経常益利回りと株価の相関計算
- **検証済み銘柄**: 9984（ソフトバンク・3月決算）、1332（日本水産・6月決算）、9983（ファーストリテイリング・8月決算）、1885（東亜建設工業）